services:
  # Using Linux router instead of pfSense for container compatibility
  firewall:
    image: ubuntu:22.04
    container_name: firewall
    cap_add:
      - NET_ADMIN
    networks:
      wan_net:
      lan_net:
      dmz_net:
    command: >
      sh -c "apt-get update && apt-get install -y iptables iproute2 suricata suricata-update &&
      sysctl -w net.ipv4.ip_forward=1 &&
      while ! ip link show eth1 > /dev/null 2>&1; do sleep 1; done &&
      iptables -A FORWARD -i eth2 -o eth1 -s 10.100.2.0/24 -d 10.100.1.0/24 -j DROP &&
      iptables -A FORWARD -i eth0 -s 10.100.0.0/24 -p icmp -j ACCEPT &&
      iptables -A FORWARD -i eth0 -s 10.100.0.0/24 -d 10.100.2.10 -p tcp --dport 80 -j ACCEPT &&
      iptables -A FORWARD -i eth0 -s 10.100.0.0/24 -j DROP &&
      (suricata-update && suricata -c /etc/suricata/suricata.yaml -i eth1 -D) ;
      tail -f /dev/null"
    restart: unless-stopped

  dmz-web:
    image: nginx:alpine
    container_name: dmz-web
    cap_add:
      - NET_ADMIN
    networks:
      dmz_net:
        ipv4_address: 10.100.2.10
    volumes:
      - ./web-content:/usr/share/nginx/html

  lan-client:
    image: alpine:latest
    container_name: lan-client
    cap_add:
      - NET_ADMIN
    networks:
      lan_net:
        ipv4_address: 10.100.1.100
    command: ["sh", "-c", "apk add curl && tail -f /dev/null"]

  attacker:
    image: alpine:latest
    container_name: attacker
    cap_add:
      - NET_ADMIN
    networks:
      wan_net:
    command: ["sh", "-c", "apk add curl nmap && tail -f /dev/null"]

networks:
  wan_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/24
  lan_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.1.0/24
  dmz_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.2.0/24